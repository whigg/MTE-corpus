 AN INTEGRATED WORKFLOW FOR PRODUCING DIGITAL TERRAIN MODELS OF MARS FROM CTX AND HIRISE STEREO DATA USING THE NASA AMES STEREO PIPELINE.  David P. Mayer1, Edwin S. Kite1, 1University of Chicagoâ€”Department of Geophysical Sciences (dpmayer@uchicago.edu). Introduction:  Stereo images represent a key dataset for producing digital terrain models (DTMs) of planetary surfaces.  Nearly all of the high-resolution (<10 meters/pixel) stereo image data of Mars comes from the CTX and HiRISE sensors.  However, CTX DTMs are not available through the PDS and fewer than 300 of the ~4400 HiRISE targeted stereopairs have been transformed to DTMs and released to the PDS as of December 2015. This often requires researchers who wish to incorporate CTX and HiRISE elevation data in their work to produce their own DTMs.  The NASA Ames Stereo Pipeline (ASP) is a free software package that can be used to create DTMs from stereo image data collected by a variety of sensors including CTX and HiRISE [1,2]. Here, we outline a procedure for producing CTX and HiRISE DTMs using ASP. The workflow is highly automated through the use of several Bash scripts that act as wrappers around the ASP routines and is configured for parallel processing in either a distributed com puting environment or on a single machine. A humanin-the-loop is required at key steps in order to assess the overall quality of the stereo triangulation results and to estimate parameters necessary for aligning a preliminary DTM to reference elevation data. The workflow uses only free, open-source software, which minimizes the costs associated with producing DTMs. Image Selection:  We identify HiRISE stereo data for a given region of interest using the HiRISE team's database of deliberately targeted stereopairs (http://www.uahirise.org/stereo_pairs.php). We then select CTX stereopairs by first searching the PDS for images that were acquired simultaneously with the HiRISE images.  If a corresponding CTX image pair is not available, we instead use the criteria outlined in [3] to identify alternative CTX image pairs that overlap with a given HiRISE stereopair. CTX Processing:   Preprocessing.  The CTX Experimental Data Records (EDRs) are prepared for ASP using the USGS Integrated Software for Imagers and Spectrometers (ISIS).  The image data are converted from PDS to ISIS cube format with mroctx2isis. SPICE kernels are added to each image using spiceinit and the pointing data are smoothed using spicefit. A photometric calibration is applied using ctxcal followed by a correction for even/odd detector striping using ctxevenodd. Bundle Adjustment.  Each preprocessed stereopair is then bundle adjusted using ASP's bundle_adjust tool. We have found that including this step minimizes "washboarding" in the final DTMs. Preliminary Point Cloud/DTM Generation.  ASP's parallel_stereo routine is used to generate an initial 3dimensional point cloud for each stereopair. The use of the parallelized implementation of stereo allows much of the stereo extraction process to be distributed among many CPUs on potentially many computers, thereby increasing computational efficiency and reducing the time required to create a single point cloud. ASP's point2dem routine is then used to transform the point cloud into a DTM.  Point Cloud Alignment to MOLA.  The preliminary CTX point cloud is aligned to MOLA datum elevations using ASP's pc_align routine. pc_align uses an iterative closest points algorithm to identify a 3-dimensional affine transform that optimizes the alignment between the ASP-derived point cloud and a reference elevation data set (i.e. MOLA). The routine requires an estimate of the largest expected displacement between the source and reference elevation data. We import individual MOLA shot data that overlaps the CTX DTM into a GIS-compatible format and calculate the difference between the MOLA elevations and the nearest CTX DTM pixel.  An analyst then inspects a histogram of the elevation differences and estimates the maximum displacement parameter for pc_align. We have found that an appropriate value typically corresponds to somewhere between the 95th and 99th-percentile of the differences between the MOLA and CTX elevations, after removing shots from MOLA orbits that are obvious outliers (elevation differences >>~4 standard deviations). Final DTM and Orthoimage Generation. We produce a final CTX DTM and orthorectified version of the nadir-most image in the stereopair by passing the point cloud output by pc_align and the nadir-most image as input to point2dem. HiRISE Processing:  Preprocessing.  HiRISE EDRs are prepared for stereo processing using two Python scripts that are part of ASP. The Python scripts are wrappers for several ISIS routines. hiedr2mosaic.py ingests the EDRs into ISIS, apply SPICE kernels, smooth the SPICE data, perform photometric calibrations and mosaics the individual CCDs from each image. cam2map4stereo.py is then used to transform the images from each stereopair to a common map projection and spatial resolution.  Preliminary Point Cloud/DTM Generation.  The map-projected images are passed as input to  parallel_stereo and the resulting point cloud is passed to point2dem in order to create a preliminary DTM. Point Cloud Alignment to CTX.  The preliminary HiRISE point cloud is aligned to a corresponding CTX DTM using pc_align.  In order to estimate the maximum displacement parameter, an analyst first subtracts the preliminary HiRISE DTM from the reference CTX DTM and then inspects the histogram of the resulting difference raster. An appropriate value for the maximum displacement typically corresponds to approximately the 99th-percentile of the differences between the reference CTX DTM and the preliminary HiRISE DTM. Final DTM Generation.  We produce a final HiRISE DTM and orthorectified version of the nadirmost image of the stereopair using point2dem following a similar approach to that used with the CTX data. DTM Availability: Our lab has produced CTX and HiRISE DTMs of sedimentary rocks in central Valles Marineris, Gunjur crater, Gale crater, and a small number of sites reported in the literature to contain chlorides. A list of DTMs that have been produced so far can be obtained from the lead author.  Individual DTMs will be made available on request. Code Availability:  We plan to release the Bash scripts used in our CTX and HiRISE processing workflow and corresponding documentation through the University of Chicago's Git repository (https://psdrepo.uchicago.edu/groups/kite-lab) in spring 2016. Prerelease versions of the scripts are available from the lead author upon request. References: [1] Moratto, Z. M., et al. (2010). Ames Stereo Pipeline, LPSC XLI, Abstract #2364. [2] Broxton, M. J. and Edwards, L. J. (2008), LPSC XXXIX, Abstract #2419. [3] Becker, K.J. et al (2015), LPSC XLVI, Abstract # 2703. Acknowledgments: The authors wish to thank O. Alexandrov, F. Calef and C. Fassett for helpful discussions about stereo image processing. This work was completed in part with resources provided by the University of Chicago Research Computing Center.  https://psd-repo.uchicago.edu/groups/kite-lab https://psd-repo.uchicago.edu/groups/kite-lab